// Prisma schema for Suba&Go auction app
// Compatible with Vercel Postgres integration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")

}

// Enums matching TypeORM enums
enum UserRoleEnum {
  ADMIN
  USER
  AUCTION_MANAGER

  @@map("user_role_enum")
}

enum ItemStateEnum {
  DISPONIBLE
  EN_SUBASTA
  VENDIDO
  ELIMINADO

  @@map("item_state_enum")
}

enum AuctionStatusEnum {
  PENDIENTE
  ACTIVA
  COMPLETADA
  CANCELADA
  ELIMINADA

  @@map("auction_status_enum")
}

enum LegalStatusEnum {
  TRANSFERIBLE
  LEASING
  POSIBILIDAD_DE_EMBARGO
  PRENDA
  OTRO

  @@map("legal_status_enum")
}

enum AuctionTypeEnum {
  TEST
  REAL

  @@map("auction_type_enum")
}

enum FeedbackStatusEnum {
  PENDING
  REVIEWED
  RESOLVED

  @@map("feedback_status_enum")
}

// Base model with common fields matching TypeORM BaseEntity
model User {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // User-specific fields matching TypeORM entity
  name        String?
  email       String
  phone       String?
  password    String
  rut         String?
  public_name String?
  role        UserRoleEnum @default(AUCTION_MANAGER)

  // Relations
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  // Auction-related relations
  bids                 Bid[]
  auctionRegistrations AuctionRegistration[]
  auditLogs            AuditLog[]
  itemsPurchased       Item[]                @relation("ItemSales")
  feedback             Feedback[]
  sentInvitations      Invitation[]          @relation("SentInvitations")

  // Unique constraints matching TypeORM indexes
  @@unique([email], map: "IDX_user_email_unique")
  @@unique([rut], map: "IDX_user_rut_unique")
  @@map("user")
}

model Tenant {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Relations
  users        User[]
  companies    Company[]
  items        Item[]
  auctions     Auction[]
  bids         Bid[]
  observations Observation[]
  feedback     Feedback[]
  invitations  Invitation[]

  @@map("tenant")
}

model Company {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Company-specific fields matching TypeORM entity
  name                    String  @unique
  nameLowercase           String  @unique // Lowercase version for case-insensitive subdomain lookup
  logo                    String?
  background_logo_enabled Boolean @default(false) // Enable logo as transparent background
  principal_color         String?
  principal_color2        String?
  secondary_color         String?
  secondary_color2        String?
  secondary_color3        String?

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users    User[]
  invitations Invitation[]

  // Unique constraint matching TypeORM index
  @@unique([name, tenantId], map: "IDX_company_name_tenant_unique")
  @@map("company")
}

model Item {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Item-specific fields matching TypeORM entity
  plate        String
  brand        String
  model        String?
  year         Int?
  version      String?
  photos       String?
  docs         String?
  kilometraje  Int?
  legal_status LegalStatusEnum @default(TRANSFERIBLE)
  state        ItemStateEnum @default(DISPONIBLE)
  basePrice    Int 
  description  String?

  // Sale tracking fields
  soldPrice    Int?
  soldAt       DateTime?
  soldToUserId String?
  soldToUser   User?     @relation("ItemSales", fields: [soldToUserId], references: [id], onDelete: SetNull)

  // Relations
  tenantId     String
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  auctionItems AuctionItem[]

  @@index([soldToUserId])
  @@map("item")
}

model Auction {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Auction-specific fields (will be added when we have the TypeORM entity details)
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  status      AuctionStatusEnum @default(PENDIENTE)
  type        AuctionTypeEnum   @default(REAL)

  // Global per-auction bid increment (applies to all items in this auction)
  bidIncrement Int @default(50000)
  itemIds      String[] @default([])

  // Relations
  tenantId        String
  tenant          Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items           AuctionItem[]
  bids            Bid[]
  registeredUsers AuctionRegistration[]

  @@index([tenantId, status])
  @@index([startTime, endTime])
  @@map("auction")
}

model AuctionItem {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  startingBid Int

  // Relations
  auctionId String
  auction   Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  itemId    String
  item      Item    @relation(fields: [itemId], references: [id], onDelete: Cascade)
  bids      Bid[]

  @@map("auction_item")
}

// Many-to-many relation between User and Auction (for registered users)
model AuctionRegistration {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  auctionId String
  auction   Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  // Ensure a user can only register once per auction
  @@unique([userId, auctionId])
  @@index([auctionId])
  @@index([userId])
  @@map("auction_registration")
}

model Bid {
  id        String    @id @default(uuid())
  requestId String?   @unique @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Bid-specific fields matching TypeORM entity
  offered_price Int
  bid_time      DateTime @default(now())

  // Relations
  tenantId      String
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  auctionId     String
  auction       Auction     @relation(fields: [auctionId], references: [id])
  auctionItemId String
  auctionItem   AuctionItem @relation(fields: [auctionItemId], references: [id])

  @@index([auctionItemId, offered_price(sort: Desc)])
  @@index([auctionId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("bid")
}

model Observation {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Observation-specific fields matching TypeORM entity
  title       String
  description String

  // Relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("observation")
}

model AuditLog {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // AuditLog-specific fields
  action     String
  entityType String
  entityId   String
  changes    Json?

  // Relations
  userId   String?
  user     User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  tenantId String?

  @@index([userId])
  @@index([tenantId])
  @@index([entityType, entityId])
  @@map("audit_log")
}

model Feedback {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  // Feedback-specific fields
  category String // Categoría: Comentarios, Feedback, Consejos, Críticas (extensible)
  title    String
  message  String             @db.Text
  status   FeedbackStatusEnum @default(PENDING)

  // Relations
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@index([status])
  @@index([category])
  @@map("feedback")
}

model Invitation {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  email     String
  token     String   @unique
  expiresAt DateTime
  role      UserRoleEnum @default(USER)
  
  // Relations
  invitedByUserId String
  invitedByUser   User   @relation("SentInvitations", fields: [invitedByUserId], references: [id])
  
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  isUsed    Boolean  @default(false)
  usedAt    DateTime?

  @@index([email])
  @@index([token])
  @@map("invitation")
}